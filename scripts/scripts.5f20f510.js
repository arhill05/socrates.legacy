"use strict";angular.module("angularfireApp",["ngAnimate","ngRoute","ngTouch","firebase","firebase.ref"]).run(["$rootScope","$location","Auth","Ref",function(a,b,c,d){var e=c.$getAuth();if(e){var f=d.child("Users");f.orderByChild("uid").equalTo(e.uid).on("child_added",function(b){a.username=b.val().email,a.$apply()})}else a.username="not logged in",a.$apply();c.$onAuth(function(b){e=b,a.$apply()}),a.$on("$routeChangeError",function(a,b,c,d){"AUTH_REQUIRED"===d&&(a.preventDefault(),toastr.error("You must be logged in to do that!"))})}]).factory("globalUser",function(){var a="not logged in",b={};return b.changeName=function(b){a=b},b.name=function(){return a},b}),angular.module("angularfireApp").factory("Auth",["$firebaseAuth",function(a){var b=new Firebase("https://burning-heat-1866.firebaseio.com");return a(b)}]),angular.module("angularfireApp").factory("User",["Ref","Auth","$firebaseArray",function(a,b,c){var d="",e={},f=a.child("Users");return e.getUser=function(a){return f.orderByChild("uid").equalTo(a).on("child_added",function(a){d=a.key()}),d},e.getUserSessions=function(b){var d=e.getUser(b),f=a.child("Users/"+d+"/userSessions"),g=c(f);return g.$loaded().then(function(a){console.log("Success",g)})["catch"](function(a){console.error("Error",a)}),g},e.getUserSessionsPath=function(b){var c=e.getUser(b),d=a.child("Users/"+c+"/userSessions");return d},e.getUserQuestions=function(b){e.getUser(b);var f=a.child("Users/"+d).child("upvotedQuestions"),g=c(f);return g},e}]),angular.module("angularfireApp").controller("MainCtrl",["$scope","$rootScope","$location","Auth","Ref",function(a,b,c,d,e){a.auth=d.$getAuth(),a.anonymousLogin=function(){d.$authAnonymously().then(function(d){a.randomNames=["Plato","Aristotle","Aedesia","Atticus","Colotes","Euphrates","Protagoras","Pyrrho","Thales","Xenophilus","Theano"],a.randomColors=["Blue","Red","Purple","Orange","Yellow","Green"],a.authData=d;var f=a.randomColors[Math.floor(Math.random()*a.randomColors.length)],g=a.randomNames[Math.floor(Math.random()*a.randomNames.length)],h="Anonymous "+f+" "+g;e.child("Users").push({uid:d.uid,email:h,upvotedQuestions:{},anonymous:!0}),b.username=h,c.path("/sessions")})["catch"](function(a){console.log(a)})}}]),angular.module("firebase.config",[]).constant("FBURL","https://burning-heat-1866.firebaseio.com"),angular.module("firebase.ref",["firebase","firebase.config"]).factory("Ref",["$window","FBURL",function(a,b){return new a.Firebase(b)}]),angular.module("angularfireApp").controller("SessionsCtrl",["$scope","Auth","Ref","$firebaseArray","$timeout","$location",function(a,b,c,d,e,f){function g(b){a.err=b,e(function(){a.err=null},5e3)}a.sessionsRef=c.child("sessions"),a.sessions=d(a.sessionsRef),a.sessions.$loaded()["catch"](g),a.auth=b.$getAuth(),$("#pin-input").keyup(function(a){13==a.keyCode&&$("#goButton").click()}),a.joinSession=function(){a.sessionsRef.orderByChild("pinNumber").equalTo(a.enteredPIN).on("child_added",function(b){var c=b.val().id;b.exists()?(console.log("Found",c),a.session=c,f.path("/sessions/"+c)):console.warn("Not found")})}}]),angular.module("angularfireApp").controller("CreateCtrl",["$scope","Ref","$firebaseArray","$timeout","$location","Auth","User",function(a,b,c,d,e,f,g){function h(b){a.err=b,d(function(){a.err=null},5e3)}var i=f.$getAuth();a.sessions=c(b.child("sessions").limitToLast(10)),a.sessions.$loaded()["catch"](h),a.id="",a.user=g.getUser(i.uid),a.userSessions=g.getUserSessions(i.uid),a.addSession=function(){var c=Math.floor(1e3+9e3*Math.random()),d=c.toString(),f={id:a.id,questions:{},pinNumber:d,adminUser:g.getUser(i.uid)},h=b.child("Users/"+a.user).child("userSessions");b.child("sessions/"+f.id).set(f),h.child(f.id).set(f),e.path("/sessions/"+f.id)}}]),angular.module("angularfireApp").filter("reverse",function(){return function(a){return angular.isArray(a)?a.slice().reverse():[]}}),angular.module("angularfireApp").controller("QuestionsCtrl",["$scope","Ref","$firebaseArray","$firebaseAuth","$timeout","$routeParams","Auth","User","currentAuth",function(a,b,c,d,e,f,g,h,i){function j(b){a.err=b,e(function(){a.err=null},5e3)}a.isAdmin=!1,a.session=f.sessionID,a.questions=c(b.child("sessions/"+f.sessionID+"/Questions")),b.child("sessions").orderByKey().equalTo(f.sessionID).on("child_added",function(b){a.currentSession=b.val(),a.pinNumber=a.currentSession.pinNumber,a.adminUser=a.currentSession.adminUser}),a.questions.$loaded()["catch"](j),a.auth=i,a.checkAdmin=function(){a.adminUser==a.user?a.isAdmin=!0:a.isAdmin=!1,console.log(a.isAdmin)},a.userPath=b.child("Users"),a.userPath.orderByChild("uid").equalTo(a.auth.uid).on("child_added",function(c){a.user=c.key(),a.username=c.val().email,a.checkAdmin();var d=b.child("Users/"+a.user).child("upvotedQuestions");a.userQuestions=h.getUserQuestions(a.auth.uid),a.userQuestions.$loaded().then(function(b){console.log(b.length),d.once("value",function(b){b.forEach(function(b){for(var c,d=b.key(),c=0;c<a.questions.length;c++)a.questions[c].$id==d&&($("#"+a.questions[c].$id).css("color","blue"),$("#"+a.questions[c].$id).css("font-weight","bolder"),$("#"+a.questions[c].$id).css("font-size","125%"))})})})}),a.addQuestion=function(){var b={text:a.text,upvotes:0,disabled:!1};a.questions.$add(b),a.text=""},a.upvoteQuestion=function(b){a.questions.$indexFor(b.$id);if(a.newQuestion=!0,0==a.userQuestions.length)b.upvotes=b.upvotes+1,$("#"+b.$id).css("color","blue"),$("#"+b.$id).css("font-weight","bolder"),$("#"+b.$id).css("font-size","125%"),a.userPath.child(a.user).child("upvotedQuestions/"+b.$id).set(b.$id),a.questions.$save(b);else{for(var c=0;c<a.userQuestions.length;c++)b.$id==a.userQuestions[c].$id&&(a.newQuestion=!1);a.newQuestion?(b.upvotes=b.upvotes+1,$("#"+b.$id).css("color","blue"),$("#"+b.$id).css("font-weight","bolder"),$("#"+b.$id).css("font-size","125%"),a.userPath.child(a.user).child("upvotedQuestions/"+b.$id).set(b.$id),a.questions.$save(b),a.newQuestion=!0):(b.upvotes=b.upvotes-1,$("#"+b.$id).css("color","black"),$("#"+b.$id).css("font-weight","normal"),$("#"+b.$id).css("font-size","100%"),a.questionToRemove=a.userQuestions.$getRecord(b.$id),a.userQuestions.$remove(a.questionToRemove),a.questions.$save(b),a.newQuestion=!0)}console.log("question voted")},a.callQR=function(){var a=document.URL,a=encodeURIComponent(f.sessionID),b="https://chart.googleapis.com/chart?chs=150x150&cht=qr&chl=http://www.socratesapp.co/%23/sessions/"+a;$("#QR").attr("src",b)}}]),angular.module("angularfireApp").controller("AdminSessionsCtrl",["$scope","Ref","$firebaseArray","$timeout",function(a,b,c,d){function e(b){a.err=b,d(function(){a.err=null},5e3)}a.sessions=c(b.child("sessions").limitToLast(10)),a.sessions.$loaded()["catch"](e)}]),angular.module("angularfireApp").controller("AdminQuestionsCtrl",["$scope","Ref","$firebaseArray","$timeout","$routeParams",function(a,b,c,d,e){function f(b){a.err=b,d(function(){a.err=null},5e3)}a.questions=c(b.child("sessions/"+e.sessionID+"/Questions")),b.child("sessions").orderByKey().equalTo(e.sessionID).on("child_added",function(b){a.currentSession=b.val(),a.pinNumber=a.currentSession.pinNumber}),a.questions.$loaded()["catch"](f),a.addQuestion=function(){var b={text:a.text,upvotes:0,disabled:!1};a.questions.$add(b),a.text=""},a.upvoteQuestion=function(b){var c=a.questions.$indexFor(b.$id);a.questions[c].disabled=!0,b.upvotes=b.upvotes+1,a.questions.$save(b),this.disabled=!0,$("#"+b.$id).css("pointer-events","none"),$("#"+b.$id).css("color","blue"),$("#"+b.$id).css("font-weight","bolder")}}]),angular.module("angularfireApp").config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/sessions/:sessionID",{templateUrl:"views/questions.html",controller:"QuestionsCtrl",resolve:{currentAuth:["Auth",function(a){return a.$requireAuth()}]}}).when("/sessions",{templateUrl:"views/sessions.html",controller:"SessionsCtrl",resolve:{currentAuth:["Auth",function(a){return a.$requireAuth()}]}}).when("/create",{templateUrl:"views/create.html",controller:"CreateCtrl",resolve:{currentAuth:["Auth",function(a){return a.$requireAuth()}]}}).when("/admin/sessions",{templateUrl:"views/adminSessions.html",controller:"AdminSessionsCtrl"}).when("/admin/sessions/:sessionID",{templateUrl:"views/adminQuestions.html",controller:"AdminQuestionsCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/postLogin",{templateUrl:"views/postLogin.html",controller:"PostLoginCtrl",resolve:{currentAuth:["Auth",function(a){return a.$waitForAuth()}],userSessions:["User","Auth","$q",function(a,b,c){var d=b.$getAuth();return a.getUserSessions(d.uid)}]}}).otherwise({redirectTo:"/"})}]),angular.module("angularfireApp").controller("HeaderCtrl",["$scope","$location","$rootScope","globalUser","Auth","Ref",function(a,b,c,d,e,f){a.isActive=function(a){return a===b.path()},a.auth=e,a.authData=a.auth.$getAuth(),a.auth.$onAuth(function(b){a.authData=b})}]),angular.module("angularfireApp").controller("LoginCtrl",["$rootScope","$scope","Ref","$firebaseArray","$timeout","$firebaseAuth","$location","Auth","globalUser",function(a,b,c,d,e,f,g,h,i){b.login=function(){b.email,b.password;h.$authWithPassword({email:b.email,password:b.password}).then(function(d){b.authData=d,toastr.success("Logged in successfully!"),b.userPath=c.child("Users"),b.userPath.orderByChild("uid").equalTo(b.authData.uid).on("child_added",function(b){a.username=b.val().email}),g.path("/postLogin")})["catch"](function(a){console.log(a),"INVALID_PASSWORD"==a.code?toastr.error("Oops! Your password appears to be wrong."):(toastr.error("Oops! There was an error..."+a),console.log("Login Failed!",a))})},$("#username-input").keyup(function(a){13==a.keyCode&&$("#login-button").click()}),$("#password-input").keyup(function(a){13==a.keyCode&&$("#login-button").click()}),b.signUp=function(){h.$createUser({email:b.email,password:b.password},function(a,d){if(a)switch(a.code){case"EMAIL_TAKEN":toastr.error("Oops! That email is already in use."),console.log("The new user account cannot be created because the email is already in use.");break;case"INVALID_EMAIL":toastr.error("Oops! Your email appears to be invalid."),console.log("The specified email is not a valid email.");break;case"INVALID_PASSWORD":console.log("The specified email is not a valid email.");break;default:toastr.error("Oops! Something went wrong. Here's some nerdy info: ",a),console.log("Error creating user:",a)}else console.log("Successfully created user account with uid:",d.uid),c.child("Users").push({uid:d.uid,email:b.email,upvotedQuestions:{}}),toastr.success("Successfully created your user account!")})}}]),angular.module("angularfireApp").controller("PostLoginCtrl",["$scope","$location","$rootScope","$timeout","$firebaseArray","Ref","Auth","User","currentAuth","userSessions",function(a,b,c,d,e,f,g,h,i,j){var k=i;a.hideSessions=!1,d(function(){var b=h.getUserSessions(k.uid);a.userSessions=b,a.hideSessions=!0},500),a.logout=function(){f.unauth(),c.username="not logged in",toastr.success("Logged out successfully!"),b.path("/")}}]);